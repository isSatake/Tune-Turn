var express = require('express');
var router = express.Router();
var bot = require('nodemw');

var musicTitle; //検索用の曲
var categoryList; //検索曲ページが含むカテゴリのリストObject
var musicList = []; //選択カテゴリのメンバ内楽曲ページArray

//カテゴリ抽出クエリ
var list_categories = new bot({
	server: 'ja.wikipedia.org',
	path: '/w',
	debug: true
}),
params = {
	action: 'query',
	prop: 'categories',
	titles: musicTitle
};

//カテゴリメンバ抽出クエリ
var search_by_category = new bot({
	server: 'ja.wikipedia.org',
	path: '/w',
	debug: true
}),
params = {
	action: 'query',
	list: 'categorymembers',
	cmtitle: '',
	cmprop: 'title',
	cmlimit: 100
};
console.log(search_by_category);

/* GET home page. */
router.get('/:word', function(req, res, next) {
	musicTitle = req.params.word

	//カテゴリ抽出
	list_categories.api.call(params, function(err, info, next, data){
		for(var id in info.pages){
			categoryList = info.pages[id].categories;
		}
	});

	//カテゴリメンバ抽出
	//categoryListが空じゃなかったら実行(promise)
	for(var index in categoryList){
		search_by_category.params.cmtitle = categoryList[index];
		search_by_category.api.call(params, function(err, info, next, data){
			if(info.categorymembers.length = 0){
				return true;
			}
			var c = info.categorymembers
			for(var index in c){
				musicList.push(c[index].title);
			}
		});
	}

	//レンダリング
	res.render('index', {
		title: 'Express',
		musicTitle: musicTitle,
		categoryList: categoryList,
		musicList: musicList
	});
});

module.exports = router;
